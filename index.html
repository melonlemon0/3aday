<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3 Things a Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font: Noto Sans KR -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
  />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: "Noto Sans KR", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }
    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: radial-gradient(circle at top, #e3efff, #f2f5ff);
      transition: background 0.4s ease;
    }
    body.celebrate {
      animation: pop-bg 0.8s ease;
    }
    @keyframes pop-bg {
      0% {
        background: radial-gradient(circle at top, #e3efff, #f2f5ff);
      }
      40% {
        background: radial-gradient(circle at top, #d3f4ff, #edf4ff);
      }
      100% {
        background: radial-gradient(circle at top, #e3efff, #f2f5ff);
      }
    }

    .app {
      width: 100%;
      max-width: 1100px;
      margin: 24px 10px;
      background: #ffffffee;
      border-radius: 20px;
      padding: 18px 16px 18px;
      box-shadow: 0 16px 32px rgba(80, 112, 180, 0.18);
    }
    .hidden {
      display: none !important;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    header h1 {
      margin: 0;
      font-size: 2.3rem;
      letter-spacing: 0.03em;
      color: #223a64;
    }
    .header-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn {
      border-radius: 999px;
      border: 1px solid #c6d9ff;
      background: #e1ecff;
      padding: 4px 8px;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #33456f;
    }
    .icon-btn span {
      font-size: 1.8rem;
      line-height: 1;
    }
    .icon-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(80, 112, 180, 0.3);
    }

    /* üîµ Header round emojis: same size for user + calendar */
    .user-badge,
    #calendarViewBtn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .user-badge {
      background: #ecf3ff;
      border: 1px solid #c6d9ff;
      font-size: 2rem;
      color: #2d4166;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }
    .user-badge-hidden {
      display: none;
    }

    /* üìÖ calendar emoji size */
    #calendarViewBtn span {
      font-size: 2rem;
    }

    .view {
      display: none;
    }
    .view.active {
      display: block;
    }

    .panel {
      border-radius: 18px;
      padding: 18px 16px;
    }

    /* LOGIN VIEW */
    .panel-login {
      background: #f7fbff;
      border: 1px solid #c9def7;
      text-align: center;
      padding: 40px 24px 34px;
    }
    .login-title {
      font-size: 1.9rem;
      color: #244064;
      margin: 0 0 18px;
    }
    .login-sub {
      font-size: 1rem;
      color: #66789e;
      margin-bottom: 26px;
    }
    .user-grid {
      display: flex;
      gap: 18px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .user-card {
      border-radius: 18px;
      border: 1px solid #c9def7;
      background: #ecf3ff;
      padding: 18px 22px;
      min-width: 150px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      transition: transform 0.08s, box-shadow 0.12s, background 0.12s;
      font-size: 1rem;
      color: #223a64;
    }
    .user-card:hover {
      background: #dde8ff;
      box-shadow: 0 6px 12px rgba(80, 112, 180, 0.25);
      transform: translateY(-1px);
    }
    .user-card:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 3px 7px rgba(80, 112, 180, 0.18);
    }
    .user-emoji {
      font-size: 2.6rem;
    }
    .user-name {
      font-size: 1.1rem;
    }

    /* LIST VIEW */
    .panel-tasks {
      background: #f7fbff;
      border: 1px solid #c9def7;
    }
    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .tasks-header-left {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .tasks-header-left h2 {
      margin: 0;
      font-size: 1.4rem;
      color: #244064;
    }
    .tasks-header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .weather-box {
      border-radius: 999px;
      padding: 6px 12px;
      background: #e4f0ff;
      border: 1px solid #c6d9ff;
      font-size: 0.9rem;
      color: #2d4166;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 80px;
      justify-content: center;
    }

    .date-box {
      font-size: 0.95rem;
    }
    .date-box input[type="date"] {
      border-radius: 999px;
      border: 1px solid #c9def7;
      padding: 6px 12px;
      font-size: 0.95rem;
      background: #f5f9ff;
      color: #244064;
    }
    .date-box input[type="date"]:focus {
      outline: none;
      border-color: #4c6fff;
      box-shadow: 0 0 0 2px rgba(76, 111, 255, 0.22);
      background: #ffffff;
    }

    .tasks-subtitle {
      font-size: 1.05rem;
      color: #64779e;
      margin-top: 6px;
      margin-bottom: 8px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 8px 0;
      border-bottom: 1px solid #dbe7ff;
      vertical-align: middle;
    }
    th {
      font-size: 0.95rem;
      color: #6c7da6;
      text-align: left;
    }

    .task-row {
      position: relative;
      border-radius: 14px;
    }

    .task-input {
      width: 100%;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid #c9def7;
      font-size: 1.15rem;
      background: #f5f9ff;
      transition: background 0.12s, border-color 0.12s, box-shadow 0.12s;
    }
    .task-input::placeholder {
      color: #9aaccc;
    }
    .task-input:focus {
      outline: none;
      border-color: #4c6fff;
      box-shadow: 0 0 0 2px rgba(76, 111, 255, 0.22);
      background: #ffffff;
    }

    .task-row.check-mode .task-input {
      background: linear-gradient(
        to right,
        #dff7e8 0,
        #dff7e8 50%,
        #fff5c9 50%,
        #fff5c9 100%
      );
      cursor: pointer;
    }

    .task-row.done .task-input {
      background: #dff7e8;
      border-color: #34c759;
      box-shadow: 0 0 0 2px rgba(52, 199, 89, 0.3);
    }
    .task-row.missed .task-input {
      background: #fff5c9;
      border-color: #ffd54b;
      box-shadow: 0 0 0 2px rgba(255, 213, 75, 0.35);
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .actions-row-left {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .actions-row-right {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
    }
    .actions-row button.primary {
      border-radius: 999px;
      border: none;
      padding: 9px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      background: linear-gradient(135deg, #4c6fff, #64a6ff);
      color: white;
      font-weight: 600;
      box-shadow: 0 6px 12px rgba(65, 110, 255, 0.35);
    }
    .actions-row button.primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 7px rgba(65, 110, 255, 0.25);
    }
    .actions-row button.secondary {
      border-radius: 999px;
      border: 1px solid #c6d9ff;
      padding: 8px 18px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #ecf3ff;
      color: #344672;
    }
    .actions-row button.secondary.toggled {
      background: #d6e4ff;
      border-color: #8ca8ff;
    }
    .msg {
      font-size: 0.9rem;
      min-height: 1.1em;
      color: #5c6c91;
    }
    .msg.error {
      color: #d63031;
    }
    .msg.ok {
      color: #1e8449;
    }

    /* CALENDAR VIEW */
    .panel-calendar {
      background: #f4f8ff;
      border: 1px solid #c6d9ff;
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    .calendar-header-left {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .calendar-header h2 {
      margin: 0;
      font-size: 1.3rem;
      color: #244064;
    }
    .calendar-nav {
      display: flex;
      gap: 6px;
    }
    .calendar-nav button {
      border-radius: 999px;
      border: none;
      padding: 5px 11px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #d4e1ff;
      color: #244064;
    }
    .calendar-nav button:hover {
      background: #c2d5ff;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 0.95rem;
    }
    .weekday {
      text-align: center;
      font-weight: 600;
      color: #5c6c91;
      padding: 4px 0;
      font-size: 0.9rem;
    }
    .cell {
      border-radius: 10px;
      padding: 6px 5px;
      min-height: 84px;
      cursor: pointer;
      background: #eaf1ff;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
      transition: background 0.15s, border 0.15s, transform 0.07s;
      font-size: 0.95rem;
    }
    .cell.empty {
      background: transparent;
      cursor: default;
      border: none;
    }
    .cell:hover:not(.empty) {
      border-color: #93b5ff;
      background: #dde8ff;
    }
    .cell.selected {
      border-color: #4c6fff;
      box-shadow: 0 0 0 1px #4c6fff;
      transform: translateY(-1px);
    }
    .cell.done-day {
      background: #d8f6e6;
      border-color: #34c75980;
    }
    .cell.missed-day {
      background: #ffe1e1;
      border-color: #ff6b6b80;
    }

    .cell-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    .cell-date {
      font-weight: 600;
      font-size: 1rem;
      color: #1f3354;
    }

    /* üü° Today: full yellow pill, not white inside */
    .today-date {
      border-radius: 999px;
      padding: 3px 10px;
      border: 3px solid #f3c34f;
      background: #f3c34f;
      color: #1f3354;
      font-weight: 700;
    }

    .holiday-row {
      font-size: 0.8rem;
      color: #b4466b;
      margin-bottom: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tasks-mini {
      margin-top: 2px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.9rem;
    }
    .task-chip {
      display: flex;
      align-items: flex-start;
      gap: 4px;
      white-space: normal;
      overflow: hidden;
    }
    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 3px;
    }
    .chip-dot.done {
      background: #38c172;
    }
    .chip-dot.missed {
      background: #ffd54b;
    }
    .chip-dot.pending {
      background: #95a5a6;
    }
    .chip-label {
      opacity: 0.95;
      font-size: 0.88rem;
      line-height: 1.2;
      white-space: normal;
      word-break: break-word;
    }

    /* ‚¨Ö Back button: Îçî Î∂ÄÎìúÎüΩÍ≥† Îçú ÌäÄÍ≤å */
    #backToListBtn {
      background: #e9f0ff;
      border-color: #d2def5;
      padding: 6px 14px;
      box-shadow: none;
      font-size: 0.9rem;
    }
    #backToListBtn span:first-child {
      font-size: 1rem;
      margin-right: 4px;
    }
    #backToListBtn span:last-child {
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .app {
        margin: 18px 6px;
        padding: 14px 12px;
      }
      header h1 {
        font-size: 1.9rem;
      }
      .login-title {
        font-size: 1.7rem;
      }
      .user-emoji {
        font-size: 2.6rem;
      }
      .user-name {
        font-size: 1.05rem;
      }
      .tasks-header-left h2 {
        font-size: 1.2rem;
      }
      .task-input {
        font-size: 1.05rem;
      }
      .cell {
        min-height: 76px;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: 1.7rem;
      }
      .icon-btn {
        padding: 4px 6px;
      }
      .panel {
        padding: 14px 10px;
      }
      .cell {
        min-height: 70px;
      }
      .holiday-row {
        font-size: 0.75rem;
      }
      .chip-label {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>3 Things a Day</h1>
      </div>
      <div class="header-right">
        <div id="userBadge" class="user-badge user-badge-hidden"></div>
        <!-- üóìÔ∏è emoji button -->
        <button class="icon-btn hidden" id="calendarViewBtn">
          <span>üóìÔ∏è</span>
        </button>
      </div>
    </header>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="view active">
      <section class="panel panel-login">
        <div class="login-title">Pick Yourself</div>
        <div class="login-sub"></div>
        <div class="user-grid">
          <button class="user-card" data-user-id="jaehyun">
            <div class="user-emoji">üçç</div>
            <div class="user-name">Ïû¨ÌòÑ</div>
          </button>
          <button class="user-card" data-user-id="jjack">
            <div class="user-emoji">üßëüèø</div>
            <div class="user-name">ÏßπÏßπÏù¥</div>
          </button>
          <button class="user-card" data-user-id="baam">
            <div class="user-emoji">üë®üèª‚Äçü¶±</div>
            <div class="user-name">Baam</div>
          </button>
        </div>
      </section>
    </div>

    <!-- LIST VIEW -->
    <div id="listView" class="view">
      <section class="panel panel-tasks">
        <div class="tasks-header">
          <div class="tasks-header-left">
            <h2>Today</h2>
            <div class="date-box">
              <input type="date" id="dateInput" />
            </div>
          </div>
          <div class="tasks-header-right">
            <div id="weatherBox" class="weather-box">‚õÖ --¬∞C</div>
          </div>
        </div>

        <div class="tasks-subtitle">Get em done!</div>

        <table>
          <thead>
            <tr>
              <th></th>
            </tr>
          </thead>
          <tbody id="taskBody"></tbody>
        </table>

        <div class="actions-row">
          <div class="actions-row-left">
            <button class="primary" id="saveBtn">Save</button>
            <button class="secondary" id="clearBtn">Clear</button>
            <div id="msg" class="msg"></div>
          </div>
          <div class="actions-row-right">
            <button class="secondary" id="checkModeBtn">Check</button>
          </div>
        </div>
      </section>
    </div>

    <!-- CALENDAR VIEW -->
    <div id="calendarView" class="view">
      <section class="panel panel-calendar">
        <div class="calendar-header">
          <div class="calendar-header-left">
            <button class="icon-btn" id="backToListBtn">
              <span>‚Üê</span><span>List</span>
            </button>
            <h2 id="monthLabel"></h2>
          </div>
          <div class="calendar-nav">
            <button id="prevMonth">‚óÄ</button>
            <button id="nextMonth">‚ñ∂</button>
          </div>
        </div>

        <div class="calendar-grid" id="calendarGrid"></div>
      </section>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://upiobealvympxbypfmkc.supabase.co";
    const supabaseKey =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaW9iZWFsdnltcHhieXBmbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzYxNDIsImV4cCI6MjA3ODk1MjE0Mn0.mLvGyy-eMWr-ow2b2USMg7PXKq2EUfK1fyJEsdGThKw";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const MAX_TASKS = 5;
    const STORAGE_KEY_USER = "three_things_user";

    const USERS = {
      jaehyun: { label: "Ïû¨ÌòÑ", emoji: "üçç", location: "seoul" },
      jjack: { label: "ÏßπÏßπÏù¥", emoji: "üßëüèø", location: "seoul" },
      baam: { label: "Baam", emoji: "üë®üèª‚Äçü¶±", location: "newjersey" },
    };

    const LOCATIONS = {
      seoul: {
        name: "Seoul",
        lat: 37.5665,
        lon: 126.978,
        timezone: "Asia/Seoul",
      },
      newjersey: {
        name: "New Jersey",
        lat: 40.0583,
        lon: -74.4057,
        timezone: "America/New_York",
      },
    };

    const loginView = document.getElementById("loginView");
    const listView = document.getElementById("listView");
    const calendarView = document.getElementById("calendarView");
    const calendarViewBtn = document.getElementById("calendarViewBtn");
    const backToListBtn = document.getElementById("backToListBtn");
    const userBadge = document.getElementById("userBadge");

    const taskBody = document.getElementById("taskBody");
    const dateInput = document.getElementById("dateInput");
    const saveBtn = document.getElementById("saveBtn");
    const clearBtn = document.getElementById("clearBtn");
    const checkModeBtn = document.getElementById("checkModeBtn");
    const msgEl = document.getElementById("msg");
    const weatherBox = document.getElementById("weatherBox");

    const monthLabel = document.getElementById("monthLabel");
    const calendarGrid = document.getElementById("calendarGrid");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");

    const HOLIDAYS = {
      "01-01": ["üá∞üá∑ ÏÉàÌï¥", "üá∫üá∏ New Year's Day"],
      "03-01": ["üá∞üá∑ ÏÇºÏùºÏ†à"],
      "05-05": ["üá∞üá∑ Ïñ¥Î¶∞Ïù¥ÎÇ†"],
      "06-06": ["üá∞üá∑ ÌòÑÏ∂©Ïùº"],
      "07-04": ["üá∫üá∏ Independence Day"],
      "08-15": ["üá∞üá∑ Í¥ëÎ≥µÏ†à"],
      "10-03": ["üá∞üá∑ Í∞úÏ≤úÏ†à"],
      "10-09": ["üá∞üá∑ ÌïúÍ∏ÄÎÇ†"],
      "11-11": ["üá∫üá∏ Veterans Day"],
      "12-25": ["üá∞üá∑ ÏÑ±ÌÉÑÏ†à", "üá∫üá∏ Christmas Day"],
    };

    function getHolidayLabels(dateStr) {
      const parts = dateStr.split("-");
      if (parts.length !== 3) return null;
      const key = parts[1] + "-" + parts[2];
      return HOLIDAYS[key] || null;
    }

    let selectedDate = toLocalISO(new Date());
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let monthSummary = {};
    const rowState = {};
    let currentUserId = null;
    let checkingMode = false;

    function setCurrentUser(id) {
      currentUserId = id;
      if (id && USERS[id]) {
        userBadge.textContent = USERS[id].emoji;
        userBadge.classList.remove("user-badge-hidden");
        calendarViewBtn.classList.remove("hidden");
      } else {
        userBadge.classList.add("user-badge-hidden");
        calendarViewBtn.classList.add("hidden");
      }
    }

    function showLoginView() {
      loginView.classList.add("active");
      listView.classList.remove("active");
      calendarView.classList.remove("active");
    }
    function showListView() {
      loginView.classList.remove("active");
      listView.classList.add("active");
      calendarView.classList.remove("active");
    }
    function showCalendarViewSafe() {
      if (!currentUserId) {
        showLoginView();
        return;
      }
      loginView.classList.remove("active");
      listView.classList.remove("active");
      calendarView.classList.add("active");
    }

    function toLocalISO(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function updateCheckUI() {
      const active = checkingMode;
      document.querySelectorAll(".task-row").forEach((row) => {
        row.classList.toggle("check-mode", active);
      });
      if (active) {
        checkModeBtn.classList.add("toggled");
        checkModeBtn.textContent = "Complete";
        setMsg("Green = done   Yellow = not done", "");
      } else {
        checkModeBtn.classList.remove("toggled");
        checkModeBtn.textContent = "Check";
        setMsg("", "");
      }
    }

    function refreshRowClasses(idx) {
      const row = document.querySelector(`.task-row[data-idx="${idx}"]`);
      if (!row) return;
      row.classList.remove("done", "missed");
      const st = rowState[idx].status;
      if (!rowState[idx].text.trim()) {
        rowState[idx].status = "pending";
        return;
      }
      if (st === "done") row.classList.add("done");
      else if (st === "missed") row.classList.add("missed");
    }

    function initRows() {
      taskBody.innerHTML = "";
      for (let i = 1; i <= MAX_TASKS; i++) {
        rowState[i] = { text: "", status: "pending" };
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="task-row" data-idx="${i}">
              <input class="task-input" data-idx="${i}" placeholder="Task ${i}" />
            </div>
          </td>
        `;
        taskBody.appendChild(tr);
      }

      document.querySelectorAll(".task-input").forEach((input) => {
        input.addEventListener("input", () => {
          const idx = Number(input.dataset.idx);
          rowState[idx].text = input.value;
          refreshRowClasses(idx);
        });
      });

      document.querySelectorAll(".task-row").forEach((row) => {
        row.addEventListener("click", async (e) => {
          if (!checkingMode) return;
          const idx = Number(row.dataset.idx);
          if (!rowState[idx].text.trim()) return;

          const rect = row.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const half = rect.width / 2;

          if (x < half) {
            rowState[idx].status =
              rowState[idx].status === "done" ? "pending" : "done";
          } else {
            rowState[idx].status =
              rowState[idx].status === "missed" ? "pending" : "missed";
          }
          refreshRowClasses(idx);
          playfulFeedback();
          await saveDay(selectedDate);
        });
      });

      updateCheckUI();
    }

    function applyRows(tasks) {
      for (let i = 1; i <= MAX_TASKS; i++) {
        rowState[i] = { text: "", status: "pending" };
      }
      (tasks || []).forEach((t) => {
        if (t.idx >= 1 && t.idx <= MAX_TASKS) {
          rowState[t.idx] = {
            text: t.title || "",
            status: t.status || "pending",
          };
        }
      });

      document.querySelectorAll(".task-input").forEach((input) => {
        const idx = Number(input.dataset.idx);
        input.value = rowState[idx].text;
      });

      for (let i = 1; i <= MAX_TASKS; i++) {
        refreshRowClasses(i);
      }

      updateCheckUI();
    }

    function setMsg(text, type) {
      msgEl.textContent = text || "";
      msgEl.className = "msg" + (type ? " " + type : "");
    }

    function playfulFeedback() {
      const tasksFilled = Object.values(rowState).filter((t) =>
        t.text.trim()
      );
      const allDone =
        tasksFilled.length > 0 &&
        tasksFilled.every((t) => t.status === "done");

      if (allDone) {
        setMsg("Nice. All checked ‚úÖ", "ok");
        document.body.classList.add("celebrate");
        setTimeout(() => document.body.classList.remove("celebrate"), 900);
      } else {
        setMsg("Updated", "ok");
      }
    }

    async function loadDay(dateStr) {
      if (!currentUserId) return;
      setMsg("", "");
      const { data, error } = await supabaseClient
        .from("daily_tasks")
        .select("*")
        .eq("user_id", currentUserId)
        .eq("task_date", dateStr)
        .order("idx", { ascending: true });
      if (error) {
        console.error(error);
        setMsg("Error", "error");
        applyRows([]);
        return;
      }
      applyRows(data || []);
    }

    async function saveDay(dateStr) {
      if (!currentUserId) return;
      const tasks = [];
      for (let i = 1; i <= MAX_TASKS; i++) {
        const { text, status } = rowState[i];
        if (text && text.trim()) {
          tasks.push({
            user_id: currentUserId,
            task_date: dateStr,
            idx: i,
            title: text.trim(),
            status: status || "pending",
          });
        }
      }

      const { error: delError } = await supabaseClient
        .from("daily_tasks")
        .delete()
        .eq("user_id", currentUserId)
        .eq("task_date", dateStr);
      if (delError) {
        console.error(delError);
        setMsg("Error", "error");
        return;
      }

      if (tasks.length === 0) {
        setMsg("Cleared", "ok");
        await loadMonth(currentYear, currentMonth);
        renderCalendar();
        return;
      }

      const { error: insError } = await supabaseClient
        .from("daily_tasks")
        .insert(tasks);
      if (insError) {
        console.error(insError);
        setMsg("Error", "error");
        return;
      }
      setMsg("Saved", "ok");
      await loadMonth(currentYear, currentMonth);
      renderCalendar();
    }

    async function clearDay(dateStr) {
      if (!currentUserId) return;
      const { error } = await supabaseClient
        .from("daily_tasks")
        .delete()
        .eq("user_id", currentUserId)
        .eq("task_date", dateStr);
      if (error) {
        console.error(error);
        setMsg("Error", "error");
        return;
      }
      applyRows([]);
      setMsg("Cleared", "ok");
      await loadMonth(currentYear, currentMonth);
      renderCalendar();
    }

    async function loadMonth(year, month) {
      if (!currentUserId) {
        monthSummary = {};
        return;
      }
      const from = toLocalISO(new Date(year, month, 1));
      const to = toLocalISO(new Date(year, month + 1, 0));
      const { data, error } = await supabaseClient
        .from("daily_tasks")
        .select("user_id, task_date, idx, title, status")
        .eq("user_id", currentUserId)
        .gte("task_date", from)
        .lte("task_date", to);
      if (error) {
        console.error(error);
        setMsg("Error", "error");
        monthSummary = {};
        return;
      }
      const summary = {};
      (data || []).forEach((row) => {
        const d = row.task_date;
        if (!summary[d]) {
          summary[d] = {
            total: 0,
            tasks: [],
          };
        }
        const st = row.status || "pending";
        summary[d].tasks.push({
          idx: row.idx,
          title: row.title,
          status: st,
        });
        summary[d].total++;
      });
      monthSummary = summary;
    }

    function renderCalendar() {
      calendarGrid.innerHTML = "";
      monthLabel.textContent = `${currentYear}-${String(
        currentMonth + 1
      ).padStart(2, "0")}`;

      const weekdayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      weekdayNames.forEach((w) => {
        const div = document.createElement("div");
        div.className = "weekday";
        div.textContent = w;
        calendarGrid.appendChild(div);
      });

      const first = new Date(currentYear, currentMonth, 1);
      const last = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = last.getDate();
      const startDay = first.getDay();
      const todayStr = toLocalISO(new Date());

      for (let i = 0; i < startDay; i++) {
        const empty = document.createElement("div");
        empty.className = "cell empty";
        calendarGrid.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        const d = new Date(currentYear, currentMonth, day);
        const dateStr = toLocalISO(d);
        cell.dataset.date = dateStr;
        if (dateStr === selectedDate) cell.classList.add("selected");

        const top = document.createElement("div");
        top.className = "cell-top";
        const num = document.createElement("div");
        num.className = "cell-date";
        num.textContent = day;

        if (dateStr === todayStr) {
          num.classList.add("today-date");
        }

        top.appendChild(num);
        cell.appendChild(top);

        const holidayLabels = getHolidayLabels(dateStr);
        if (holidayLabels) {
          holidayLabels.forEach((label) => {
            const holidayRow = document.createElement("div");
            holidayRow.className = "holiday-row";
            holidayRow.textContent = label;
            cell.appendChild(holidayRow);
          });
        }

        const mini = document.createElement("div");
        mini.className = "tasks-mini";
        const info = monthSummary[dateStr];
        let allDone = false;
        let allMissed = false;

        if (info && info.tasks.length > 0) {
          allDone = info.tasks.every((t) => t.status === "done");
          allMissed = info.tasks.every((t) => t.status === "missed");

          info.tasks
            .sort((a, b) => a.idx - b.idx)
            .slice(0, 5)
            .forEach((t) => {
              const chip = document.createElement("div");
              chip.className = "task-chip";
              const dot = document.createElement("span");
              dot.className =
                "chip-dot " +
                (t.status === "done"
                  ? "done"
                  : t.status === "missed"
                  ? "missed"
                  : "pending");
              const text = document.createElement("span");
              text.className = "chip-label";
              text.textContent = t.title;
              chip.appendChild(dot);
              chip.appendChild(text);
              mini.appendChild(chip);
            });
        }
        cell.appendChild(mini);

        if (info && info.tasks.length > 0) {
          if (allDone) {
            cell.classList.add("done-day");
          } else if (allMissed) {
            cell.classList.add("missed-day");
          }
        }

        cell.addEventListener("click", () => {
          selectedDate = dateStr;
          dateInput.value = selectedDate;
          loadDay(selectedDate);
          document.querySelectorAll(".cell").forEach((c) =>
            c.classList.remove("selected")
          );
          cell.classList.add("selected");
          showListView();
        });

        calendarGrid.appendChild(cell);
      }
    }

    function weatherEmoji(code, isDay) {
      if (code === 0) return isDay ? "‚òÄÔ∏è" : "üåô";
      if (code === 1 || code === 2) return "üå§Ô∏è";
      if (code === 3) return "‚òÅÔ∏è";
      if (code >= 45 && code <= 48) return "üå´Ô∏è";
      if (code >= 51 && code <= 67) return "üå¶Ô∏è";
      if (code >= 71 && code <= 77) return "üå®Ô∏è";
      if (code >= 80 && code <= 82) return "üåßÔ∏è";
      if (code >= 95 && code <= 99) return "‚õàÔ∏è";
      return "‚õÖ";
    }

    async function loadWeather() {
      if (!weatherBox || !currentUserId || !USERS[currentUserId]) return;
      const locKey = USERS[currentUserId].location || "seoul";
      const loc = LOCATIONS[locKey] || LOCATIONS["seoul"];
      try {
        const url =
          "https://api.open-meteo.com/v1/forecast?latitude=" +
          loc.lat +
          "&longitude=" +
          loc.lon +
          "&current_weather=true&timezone=" +
          encodeURIComponent(loc.timezone);
        const res = await fetch(url);
        if (!res.ok) throw new Error("weather error");
        const data = await res.json();
        const cw = data.current_weather;
        if (!cw) return;
        const temp = Math.round(cw.temperature);
        const code = cw.weathercode;
        const emoji = weatherEmoji(code, cw.is_day);
        weatherBox.textContent = `${emoji} ${temp}¬∞C`;
      } catch (e) {
        console.error(e);
        weatherBox.textContent = "‚õÖ";
      }
    }

    calendarViewBtn.addEventListener("click", () => {
      showCalendarViewSafe();
    });
    backToListBtn.addEventListener("click", () => {
      showListView();
    });

    userBadge.addEventListener("click", () => {
      currentUserId = null;
      localStorage.removeItem(STORAGE_KEY_USER);
      setCurrentUser(null);
      showLoginView();
    });

    document.querySelectorAll(".user-card").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const userId = btn.dataset.userId;
        if (!USERS[userId]) return;
        setCurrentUser(userId);
        localStorage.setItem(STORAGE_KEY_USER, userId);
        showListView();
        selectedDate = toLocalISO(new Date());
        dateInput.value = selectedDate;
        await loadMonth(currentYear, currentMonth);
        renderCalendar();
        await loadDay(selectedDate);
        loadWeather();
      });
    });

    dateInput.addEventListener("change", () => {
      if (!dateInput.value) return;
      selectedDate = dateInput.value;
      const d = new Date(selectedDate + "T00:00:00");
      currentYear = d.getFullYear();
      currentMonth = d.getMonth();
      loadMonth(currentYear, currentMonth).then(() => {
        renderCalendar();
        loadDay(selectedDate);
      });
    });

    saveBtn.addEventListener("click", () => {
      saveDay(selectedDate);
    });

    clearBtn.addEventListener("click", () => {
      if (confirm("Clear this day?")) {
        clearDay(selectedDate);
      }
    });

    checkModeBtn.addEventListener("click", async () => {
      if (!checkingMode) {
        checkingMode = true;
        updateCheckUI();
      } else {
        await saveDay(selectedDate);
        checkingMode = false;
        updateCheckUI();
      }
    });

    prevMonthBtn.addEventListener("click", () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      loadMonth(currentYear, currentMonth).then(() => {
        renderCalendar();
      });
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      loadMonth(currentYear, currentMonth).then(() => {
        renderCalendar();
      });
    });

    async function init() {
      initRows();
      selectedDate = toLocalISO(new Date());
      if (dateInput) dateInput.value = selectedDate;

      const savedUser = localStorage.getItem(STORAGE_KEY_USER);
      if (savedUser && USERS[savedUser]) {
        setCurrentUser(savedUser);
        showListView();
        await loadMonth(currentYear, currentMonth);
        renderCalendar();
        await loadDay(selectedDate);
        loadWeather();
      } else {
        setCurrentUser(null);
        showLoginView();
      }
    }

    init();
  </script>
</body>
</html>
